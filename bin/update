#!/bin/sh

clear
cd /data/local/autorepack
git="/data/data/com.termux/files/usr/bin/git"
$git remote update &> /dev/null
$git restore . &> /dev/null

fetch_updates(){
    $git fetch &> /dev/null
    commits="$($git log --pretty=format:"%s~" --date=relative master..origin/master)"
    cd /data/adb/modules/autorepacker/system/bin/
    $git fetch &> /dev/null
    commits+="$($git log --pretty=format:%s~ --date=relative master..origin/master)"
}

check_updates(){
    echo
    echo -e "\e[3mChecking for updates...\e[0m"
    fetch_updates
    echo
    if [ ! -z "$commits" ]; then
        echo -e "\e[1mUpdates:\e[0m"
        awk -F '~' '{for(i=1; i<=NF-1; i++){ print "\033[3m ◍ " toupper(substr($i,0,1))tolower(substr($i,2))"\033[0m"}}' <<< "$commits"
        echo
        echo -e "\e[1mType in 'update now' to receive the updates.\e[0m"
        echo
    else
        echo -e "\e[3mYou are currently up-to-date.\e[0m"
        echo
    fi
}

update(){
    clear
    echo
    fetch_updates
    [ -z "$commits" ] && echo -e "\e[3mYou are already up-to-date.\e[0m" && exit || unset commits
    echo -e "\e[3mUpdating...\e[0m"
    $git pull &> /dev/null
    cd /data/local/autorepack
    $git pull &> /dev/null
    fetch_updates
    chmod -R +x /data/adb/modules/autorepacker/system/bin/
    cp /data/adb/modules/autorepacker/system/bin/* /system/bin/ &> /dev/null
    [ -z "$commits" ] && echo -e "\e[3mSuccessfully updated.\e[0m" && echo || echo -e "\e[3mProblems occured during update. Here's the full output:\n\n\e[0m$($git pull)"
    echo
}

fetch_history(){
    commits=$(git log --reverse -n 10 | sed 's/^[a-zA-Z].*$//; /^$/ d')
    if [ ! -z "$commits" ]; then
        echo -e "\e[1mPast Updates:\e[0m"
        while read line; do
            echo -e "\e[3m ◍ $(echo $line| awk '{print toupper(substr($0,0,1))tolower(substr($0,2))}')\e[0m"
        done <<< $commits
        echo
    else
        echo -e "\e[3mNo past history found.\e[0m"
        echo
    fi
}

if [ -z "$1" ]; then
    check_updates
elif [ "$1" == "now" ]; then
    update
elif [ "$1" == "--history" ]; then
    fetch_history
else
    echo "Invalid argument. You have to type in 'update' to check and 'update now' to receive the updates."
fi
